//
//  ShopViewController.m
//  TeaHome
//
//  Created by andylee on 14-6-27.
//  Copyright (c) 2014年 Ali Karagoz. All rights reserved.
//

#import "ShopViewController.h"
#import "ProductViewController.h"

#define get_shop_cats_cmd @"get_shop_cats"
#define share_shop_url @"shop/html/"

@interface ShopViewController ()

@end

@implementation ShopViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];

    self.title = [self.shop objectForKey:@"title"];
    self.view.backgroundColor = [UIColor whiteColor];
    
    [self initShopInfoView];
    [self initCatsView];
//    UIBarButtonItem *share = [[UIBarButtonItem alloc] initWithTitle:@"分享"
//                                                              style:UIBarButtonItemStyleBordered
//                                                             target:self
//                                                             action:@selector(shareAction:)];
//    self.navigationItem.rightBarButtonItems = [NSArray arrayWithObjects:share, nil];
    
}

-(void)shareAction:(UIBarButtonItem *)item
{
    NSString *url = [NSString stringWithFormat:@"%@%@%d",share_root_url,share_shop_url,[[self.shop objectForKey:@"id"] intValue]];
    
    //构造分享内容
    id<ISSContent> publishContent = [ShareSDK content:url
                                       defaultContent:@"默认分享内容，没内容时显示"
                                                image:nil
                                                title:@"ShareSDK"
                                                  url:url
                                          description:@"这是一条测试信息"
                                            mediaType:SSPublishContentMediaTypeNews];
    
    [ShareSDK showShareActionSheet:nil
                         shareList:nil
                           content:publishContent
                     statusBarTips:YES
                       authOptions:nil
                      shareOptions: nil
                            result:^(ShareType type, SSResponseState state, id<ISSPlatformShareInfo> statusInfo, id<ICMErrorInfo> error, BOOL end) {
                                if (state == SSResponseStateSuccess)
                                {
                                    NSLog(@"分享成功");
                                }
                                else if (state == SSResponseStateFail)
                                {
                                    NSLog(@"分享失败,错误码:%d,错误描述:%@", [error errorCode], [error errorDescription]);
                                }
                            }];
}


-(void)initCatsView
{
    int shopId = [[self.shop objectForKey:@"id"] intValue];
    //所有店铺
    NSString *url = [NSString stringWithFormat:@"%@%@&shop=%d",CMD_URL,get_shop_cats_cmd,shopId];
    id jsonObj = [Utils getJsonDataFromWeb:url];
    if (jsonObj != nil) {
        self.cats = [NSArray arrayWithArray:(NSArray *)jsonObj];
        
        if (self.catsView == nil) {
            self.layout = [[UICollectionViewFlowLayout alloc] init];
            self.layout.minimumInteritemSpacing = 20;
            self.layout.minimumLineSpacing = 10;
            self.layout.sectionInset = UIEdgeInsetsMake(5, 5, 5, 5);
            self.layout.itemSize = CGSizeMake(90, 150);
            self.layout.headerReferenceSize = CGSizeMake(320, 20);
            
            self.catsView = [[UICollectionView alloc] initWithFrame:CGRectMake(0, self.shopInfoView.bounds.size.height + 10, self.view.bounds.size.width, self.view.bounds.size.height  - self.shopInfoView.bounds.size.height) collectionViewLayout:self.layout];
            self.catsView.autoresizingMask = UIViewAutoresizingFlexibleHeight;
            self.catsView.backgroundColor = [UIColor whiteColor];
            self.catsView.dataSource = self;
            self.catsView.delegate = self;
            [self.view addSubview:self.catsView];
            
            [self.catsView registerClass:[UICollectionViewCell class] forCellWithReuseIdentifier:NSStringFromClass([UICollectionViewCell class])];
            [self.catsView registerClass:[UICollectionReusableView class]  forSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UICollectionReusableView class])];
        }
        
        [self.catsView reloadData];
    }
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


-(void)initShopInfoView
{
    int shopId = [[self.shop objectForKey:@"id"] intValue];
    
    self.shopInfoView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, 60)];
    self.shopInfoView.autoresizingMask = UIViewAutoresizingFlexibleHeight;
    self.shopInfoView.backgroundColor = [UIColor whiteColor];
    [self.view addSubview:self.shopInfoView];
    
    NSString *product_image_url = [NSString stringWithFormat:@"%@%d.jpg",shop_image_root_url,shopId];
    NSURL *url = [NSURL URLWithString:product_image_url];
    UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(5, 5, 120, 60)];
    imageView.backgroundColor = [UIColor clearColor];
    [imageView sd_setImageWithURL:url placeholderImage:[UIImage imageNamed:@"image_loading"]];
    imageView.contentMode = UIViewContentModeScaleAspectFit;
    [self.shopInfoView addSubview:imageView];
    
    NSString *title = [self.shop objectForKey:@"title"];
    NSString *desc = [self.shop objectForKey:@"desc"];
    UILabel *infoLabel = [[UILabel alloc] initWithFrame:CGRectMake(140, 5, 120, 60)];
    infoLabel.numberOfLines = 0;
    infoLabel.backgroundColor = [UIColor clearColor];
    infoLabel.text = [NSString stringWithFormat:@"%@\n%@",title,desc];
    [self.shopInfoView addSubview:infoLabel];
    
}

#pragma mark - collection view delegate method
-(NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section
{
    NSArray *products = [[self.cats objectAtIndex:section] objectForKey:@"items"];
    return [products count];
}

-(NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView
{
    return [self.cats count];
}

-(UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath
{
    
    UICollectionReusableView *header = [collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:NSStringFromClass([UICollectionReusableView class]) forIndexPath:indexPath];
    
    NSDictionary *cat = [self.cats objectAtIndex:indexPath.section];
    
    UILabel *catLabel = [[UILabel alloc] initWithFrame:CGRectMake(10, 0, 150, 20)];
    catLabel.backgroundColor = [UIColor clearColor];
    catLabel.textColor = [Utils hexStringToColor:navigation_bar_color];
    catLabel.text = [NSString stringWithFormat:@"商品种类:%@",[cat objectForKey:@"name"]];
    
    [header addSubview:catLabel];
    
    return header;
}

-(UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath
{
    UICollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:NSStringFromClass([UICollectionViewCell class]) forIndexPath:indexPath];
    
    NSDictionary *product = [self.cats[indexPath.section] objectForKey:@"items"][indexPath.row];
    NSString *title = [product objectForKey:@"title"];
    float price = [[product objectForKey:@"price"] floatValue];
    int productId = [[product objectForKey:@"id"] intValue];
    int sold = [[product objectForKey:@"sold"] intValue];
    
    NSString *product_image_url = [NSString stringWithFormat:@"%@%d.jpg",product_image_root_url,productId];
    NSURL *url = [NSURL URLWithString:product_image_url];
    UIImageView *imageView = [[UIImageView alloc] initWithFrame:CGRectMake(5, 5, 80, 80)];
    imageView.backgroundColor = [UIColor clearColor];
    [imageView sd_setImageWithURL:url placeholderImage:[UIImage imageNamed:@"image_loading"]];
    [cell.contentView addSubview:imageView];
    
    
    UILabel *titleLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 90, cell.bounds.size.width, 20)];
    titleLabel.backgroundColor = [UIColor clearColor];
    titleLabel.numberOfLines = 0;
    titleLabel.font = [UIFont systemFontOfSize:12];
    titleLabel.textColor = [UIColor blackColor];
    titleLabel.text = title;
    [cell.contentView addSubview:titleLabel];
    
    UILabel *soldLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 110, cell.bounds.size.width, 20)];
    soldLabel.backgroundColor = [UIColor clearColor];
    soldLabel.numberOfLines = 0;
    soldLabel.font = [UIFont systemFontOfSize:12];
    soldLabel.textColor = [UIColor blackColor];
    soldLabel.text = [NSString stringWithFormat:@"销量:%d",sold];;
    [cell.contentView addSubview:soldLabel];
    
    UILabel *priceLabel = [[UILabel alloc] initWithFrame:CGRectMake(0, 130, cell.bounds.size.width, 20)];
    priceLabel.backgroundColor = [UIColor clearColor];
    priceLabel.numberOfLines = 0;
    priceLabel.font = [UIFont systemFontOfSize:12];
    priceLabel.textColor = [UIColor blackColor];
    priceLabel.text = [NSString stringWithFormat:@"价格:%.1f元",price];
    [cell.contentView addSubview:priceLabel];

    
    return cell;
}

-(void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath
{
    NSDictionary *product = [self.cats[indexPath.section] objectForKey:@"items"][indexPath.row];

    ProductViewController *pvc = [[ProductViewController alloc] init];
    pvc.product = product;
    [self.navigationController pushViewController:pvc animated:YES];
}
@end
